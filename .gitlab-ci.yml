image: "ubuntu:bionic"

stages:
  - build_library
  - build_tests
  - test
  - documentation
  - publish

before_script:
  - apt-get update

building:
  stage: build_library
  script:
    - apt-get -y install build-essential
    - version=3.11
    - build=4
    - mkdir temp
    - cd temp
    - apt-get -y install wget
    - wget https://cmake.org/files/v$version/cmake-$version.$build.tar.gz
    - tar -xzvf cmake-$version.$build.tar.gz
    - cd cmake-$version.$build/
    - ./bootstrap
    - make -j$(nproc)
    - make install
    - cd ../..
    - rm -r temp
    - mkdir build && cd build
    - cmake ..
    - make fnsim
    - cd ..

building_node_test:
  stage: build_tests
  script:
  - cd build
  - make test_node
  - cd ..

building_link_test:
  stage: build_tests
  script:
  - cd build
  - make test_link
  - cd ..

building_network_test:
  stage: build_tests
  script:
  - cd build
  - make test_network
  - cd ..

testing:
  stage: test
  script:
  - cd build
  - make test
  - cd ..

make_documentation:
  stage: documentation
  script:
  - apt-get -y install graphviz
  - apt-get -y install doxygen
  - doxygen Doxyfile
  except:
  - master
  
pages:
  stage: publish
  script:
  - mv documentation/html/ public/
  artifacts:
    paths:
    - public
  only:
  - master
